<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Language Detection Script - Must load first -->
    <script>
        // Priority order: 1) Stored preference, 2) URL parameter, 3) Browser/OS language
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        const storedLang = localStorage.getItem('appLanguage');
        const userLang = navigator.language || navigator.userLanguage;
        
        // Determine language with priority
        let langCode;
        if (storedLang) {
            // Use stored preference (from installation or user choice)
            langCode = storedLang;
        } else if (urlLang) {
            // Use URL parameter
            langCode = urlLang;
        } else {
            // Use browser/OS language
            langCode = userLang.toLowerCase().split('-')[0];
        }
        
        const isNL = langCode === 'nl';
        
        // Store the language preference for future sessions
        if (!storedLang) {
            localStorage.setItem('appLanguage', isNL ? 'nl' : 'en');
        }
        
        // Set HTML lang attribute and load appropriate manifest
        document.documentElement.lang = isNL ? 'nl' : 'en';
        
        // Dynamically set the manifest with cache-busting for icon updates
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = (isNL ? './manifest.nl.json' : './manifest.json') + '?v=1.7.4';
        document.head.appendChild(manifestLink);
        
        console.log('[Language] Detected:', isNL ? 'Dutch (nl)' : 'English (en)', '| Source:', storedLang ? 'Stored' : urlLang ? 'URL' : 'OS/Browser');
    </script>
    
    <!-- Primary Meta Tags -->
    <title>Space Voyage - Interactive 3D Solar System & VR Experience</title>
    <meta name="title" content="Space Voyage - Interactive 3D Solar System & VR Experience">
    <meta name="description" content="Explore our Solar System in stunning 3D with VR/AR support. Navigate through planets, moons, spacecraft, nebulae, and galaxies in this free interactive educational experience.">
    <meta name="keywords" content="space, solar system, 3D, VR, AR, planets, astronomy, education, interactive, WebXR, Three.js, stars, galaxies, NASA, spacecraft">
    <meta name="author" content="Space Voyage">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://my-pwa-apps.github.io/Solar/">
    <meta property="og:title" content="Space Voyage - Interactive 3D Solar System & VR Experience">
    <meta property="og:description" content="Explore our Solar System in stunning 3D with VR/AR support. Navigate through planets, moons, spacecraft, nebulae, and galaxies in this free interactive educational experience.">
    <meta property="og:image" content="https://my-pwa-apps.github.io/Solar/screenshots/solar1.png">
    <meta property="og:image:width" content="1920">
    <meta property="og:image:height" content="1080">
    <meta property="og:site_name" content="Space Voyage">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="nl_NL">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://my-pwa-apps.github.io/Solar/">
    <meta name="twitter:title" content="Space Voyage - Interactive 3D Solar System & VR Experience">
    <meta name="twitter:description" content="Explore our Solar System in stunning 3D with VR/AR support. Navigate through planets, moons, spacecraft, nebulae, and galaxies.">
    <meta name="twitter:image" content="https://my-pwa-apps.github.io/Solar/screenshots/solar1.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0078D4" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000011" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Space Voyage">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Space Voyage">
    <meta name="msapplication-TileColor" content="#0078D4">
    <meta name="msapplication-config" content="./browserconfig.xml">
    <meta name="msapplication-square70x70logo" content="./icons/windows11/SmallTile.scale-100.png">
    <meta name="msapplication-square150x150logo" content="./icons/windows11/Square150x150Logo.scale-100.png">
    <meta name="msapplication-wide310x150logo" content="./icons/windows11/Wide310x150Logo.scale-100.png">
    <meta name="msapplication-square310x310logo" content="./icons/windows11/LargeTile.scale-100.png">
    <meta name="msapplication-tooltip" content="Space Voyage - Interactive 3D Solar System">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Fullscreen & Immersive Mode -->
    <meta name="fullscreen" content="yes">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="any">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    
    <!-- PWA Manifest - Loaded dynamically based on language above -->
    
    <!-- Favicon - Using unplated versions for Windows taskbar/Start Menu/Title Bar -->
    <!-- Modern browsers prefer PNG, but ICO ensures maximum compatibility -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/windows11/Square44x44Logo.altform-unplated_targetsize-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/windows11/Square44x44Logo.altform-unplated_targetsize-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="./icons/windows11/Square44x44Logo.altform-unplated_targetsize-48.png">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    <link rel="shortcut icon" type="image/png" href="./icons/windows11/Square44x44Logo.altform-unplated_targetsize-32.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/manifest-icon-192.maskable.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/manifest-icon-512.maskable.png">
    
    <!-- Windows 11 App Icon (unplated for taskbar/Start Menu) -->
    <link rel="icon" type="image/png" sizes="44x44" href="./icons/windows11/Square44x44Logo.altform-unplated_targetsize-44.png">
    
    <!-- Performance optimization -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./src/i18n.js" as="script">
    <link rel="preload" href="./src/styles/main.css" as="style">
    <link rel="preload" href="./src/styles/ui.css" as="style">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="./src/styles/main.css">
    <link rel="stylesheet" href="./src/styles/ui.css">
    
    <!-- Load translations early -->
    <script src="./src/i18n.js"></script>
</head>
<body>
    <header id="main-header" role="banner">
        <div class="logo">
            <h1 data-i18n="appTitle">Space Voyage</h1>
        </div>
        <div class="header-controls">
            <nav id="quick-nav" aria-label="Quick navigation">
                <select id="object-dropdown" class="nav-dropdown" aria-label="Navigate to celestial object">
                    <option value="" selected data-i18n="quickNavigation">Quick Navigation</option>
                    <optgroup label="Our Star" data-i18n="ourStar">
                        <option value="sun" data-i18n="sun">Sun</option>
                    </optgroup>
                    <optgroup label="Mercury" data-i18n="mercury">
                        <option value="mercury" data-i18n="mercury">Mercury</option>
                    </optgroup>
                    <optgroup label="Venus" data-i18n="venus">
                        <option value="venus" data-i18n="venus">Venus</option>
                    </optgroup>
                    <optgroup label="Earth System" data-i18n="earthSystem">
                        <option value="earth" data-i18n="earth">Earth</option>
                        <option value="moon" data-i18n="moon">Moon</option>
                    </optgroup>
                    <optgroup label="Mars System" data-i18n="marsSystem">
                        <option value="mars" data-i18n="mars">Mars</option>
                        <option value="phobos">Phobos</option>
                        <option value="deimos">Deimos</option>
                    </optgroup>
                    <optgroup label="Jupiter System">
                        <option value="jupiter">Jupiter</option>
                        <option value="io">Io</option>
                        <option value="europa">Europa</option>
                        <option value="ganymede">Ganymede</option>
                        <option value="callisto">Callisto</option>
                    </optgroup>
                    <optgroup label="Saturn System">
                        <option value="saturn">Saturn</option>
                        <option value="titan">Titan</option>
                        <option value="enceladus">Enceladus</option>
                        <option value="rhea">Rhea</option>
                    </optgroup>
                    <optgroup label="Uranus System">
                        <option value="uranus">Uranus</option>
                        <option value="titania">Titania</option>
                        <option value="miranda">Miranda</option>
                    </optgroup>
                    <optgroup label="Neptune System">
                        <option value="neptune">Neptune</option>
                        <option value="triton">Triton</option>
                    </optgroup>
                    <optgroup label="Pluto System">
                        <option value="pluto">Pluto</option>
                        <option value="charon">Charon</option>
                    </optgroup>
                    <optgroup label="Nearby Stars">
                        <option value="alpha-centauri">Alpha Centauri</option>
                        <option value="proxima-centauri">Proxima Centauri</option>
                    </optgroup>
                    <optgroup label="Exoplanets">
                        <option value="proxima-b">Proxima Centauri b</option>
                        <option value="kepler-452b">Kepler-452b</option>
                        <option value="trappist-1e">TRAPPIST-1e</option>
                        <option value="kepler-186f">Kepler-186f</option>
                    </optgroup>
                    <optgroup label="Nebulae">
                        <option value="orion-nebula">Orion Nebula</option>
                        <option value="crab-nebula">Crab Nebula</option>
                        <option value="ring-nebula">Ring Nebula</option>
                    </optgroup>
                    <optgroup label="Galaxies">
                        <option value="andromeda-galaxy">Andromeda Galaxy</option>
                        <option value="whirlpool-galaxy">Whirlpool Galaxy</option>
                        <option value="sombrero-galaxy">Sombrero Galaxy</option>
                    </optgroup>
                    <optgroup label="Constellations (Zodiac)" data-i18n="constellationsZodiac">
                        <option value="constellation-aries">Aries</option>
                        <option value="constellation-taurus">Taurus</option>
                        <option value="constellation-gemini">Gemini</option>
                        <option value="constellation-cancer">Cancer</option>
                        <option value="constellation-leo">Leo</option>
                        <option value="constellation-virgo">Virgo</option>
                        <option value="constellation-libra">Libra</option>
                        <option value="constellation-scorpius">Scorpius</option>
                        <option value="constellation-sagittarius">Sagittarius</option>
                        <option value="constellation-capricornus">Capricornus</option>
                        <option value="constellation-aquarius">Aquarius</option>
                        <option value="constellation-pisces">Pisces</option>
                    </optgroup>
                    <optgroup label="Constellations (Other)" data-i18n="constellationsOther">
                        <option value="constellation-orion">Orion</option>
                        <option value="constellation-big-dipper">Big Dipper</option>
                        <option value="constellation-little-dipper">Little Dipper</option>
                        <option value="constellation-southern-cross">Southern Cross</option>
                        <option value="constellation-cassiopeia">Cassiopeia</option>
                        <option value="constellation-cygnus">Cygnus</option>
                        <option value="constellation-lyra">Lyra</option>
                        <option value="constellation-andromeda">Andromeda</option>
                        <option value="constellation-perseus">Perseus</option>
                    </optgroup>
                    <optgroup label="Spacecraft & Probes">
                        <option value="iss">ISS</option>
                        <option value="hubble">Hubble</option>
                        <option value="voyager-1">Voyager 1</option>
                        <option value="voyager-2">Voyager 2</option>
                        <option value="new-horizons">New Horizons</option>
                        <option value="parker-solar-probe">Parker Solar Probe</option>
                        <option value="juno">Juno (Jupiter)</option>
                        <option value="cassini">Cassini (Saturn)</option>
                        <option value="pioneer-10">Pioneer 10</option>
                        <option value="pioneer-11">Pioneer 11</option>
                    </optgroup>
                </select>
            </nav>
            <select id="language-selector" class="language-selector" aria-label="Select language">
                <option value="en">🇬🇧 English</option>
                <option value="nl">🇳🇱 Nederlands</option>
            </select>
            <button id="help-button" aria-label="Show help" data-tooltip="Show help and controls (H)" data-i18n="help">Help</button>
        </div>
    </header>
    <main id="canvas-container" role="main" aria-label="3D visualization canvas"></main>
    
    <div id="loading" role="status" aria-live="polite">
        <div class="loading-spinner"></div>
        <p id="loading-text" data-i18n="initializing">Initializing...</p>
        <div id="loading-progress">
            <div id="loading-progress-bar"></div>
        </div>
        <p id="loading-percentage">0%</p>
    </div>
    <aside id="info-panel" class="hidden" role="complementary" aria-labelledby="object-name">
        <button class="close-btn" onclick="window.closeInfoPanel()" aria-label="Close information panel">✕</button>
        <h2 id="object-name" data-i18n="selectObject">Select an Object</h2>
        <div class="info-content">
            <p><strong data-i18n="type">Type:</strong> <span id="object-type">-</span></p>
            <p><strong data-i18n="distance">Distance:</strong> <span id="object-distance">-</span></p>
            <p><strong data-i18n="size">Size:</strong> <span id="object-size">-</span></p>
            <div id="object-description" class="description-box" data-i18n="clickToExplore">
                Click on objects to explore and learn more
            </div>
        </div>
    </aside>
    <!-- Bottom Bar -->
    <footer id="main-footer" role="contentinfo">
        <div class="footer-controls">
            <div class="control-group">
                <label for="time-speed" data-i18n="speedLabel">Speed:</label>
                <input type="range" id="time-speed" min="0" max="5" value="1" step="0.1" aria-label="Animation speed" />
                <span id="time-speed-label" data-i18n="realTime">1x Real-time</span>
            </div>
            
            <button id="toggle-orbits" aria-label="Toggle orbital paths" data-tooltip="Show/hide orbital paths (O)" data-i18n="toggleOrbits">Orbits</button>
            <button id="toggle-constellations" aria-label="Toggle constellations" data-tooltip="Show/hide star constellations (C)" data-i18n="toggleConstellations">Constellations</button>
            <button id="toggle-details" aria-label="Toggle details" data-tooltip="Toggle object labels (D)" data-i18n="toggleLabels">Labels OFF</button>
            <button id="toggle-scale" aria-label="Toggle realistic scale" class="scale-btn active" data-tooltip="Switch between educational and realistic scale (S)" data-i18n="toggleScale">Educational Scale</button>
            <button id="reset-view" aria-label="Reset camera view" data-tooltip="Reset camera to default view (R)" data-i18n="resetView">Reset</button>
        </div>
        
        <div class="footer-xr-controls">
            <div id="vr-button" class="hidden"></div>
            <div id="ar-button" class="hidden"></div>
        </div>
    </footer>
    
    <div id="fps-counter" class="hidden" aria-live="polite">FPS: <span id="fps-value">60</span></div>
    
    <!-- Tracking Mode Indicator - REMOVED (was distracting)
    <div id="tracking-indicator" role="status" aria-live="polite">
        <div class="tracking-icon"></div>
        <span class="tracking-text">Tracking Object</span>
        <button class="tracking-close" aria-label="Stop tracking" title="Stop tracking">×</button>
    </div>
    -->
    
    <!-- PWA Install Prompt -->
    <div id="install-prompt" class="hidden" role="dialog" aria-labelledby="install-title">
        <div class="install-content">
            <div class="install-icon">📱</div>
            <h3 id="install-title" data-i18n="installTitle">Install Space Voyage</h3>
            <p data-i18n="installMessage">Install this app for a better experience and offline access!</p>
            <div class="install-buttons">
                <button id="install-accept" class="btn-primary" data-i18n="install">Install</button>
                <button id="install-dismiss" class="btn-secondary" data-i18n="notNow">Not Now</button>
            </div>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="hidden" role="status" aria-live="polite">
        <span class="offline-icon">📡</span>
        <span class="offline-text" data-i18n="offlineMode">You're offline</span>
    </div>
    
    <!-- Update Available Notification -->
    <div id="update-notification" class="hidden" role="status" aria-live="polite">
        <span class="update-icon">🔄</span>
        <span class="update-text" data-i18n="updateAvailable">Update available!</span>
        <button id="update-reload" class="btn-update" data-i18n="update">Update</button>
        <button id="update-dismiss" class="btn-dismiss">×</button>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="modal hidden" role="dialog" aria-labelledby="help-title" aria-modal="true">
        <div class="modal-content">
            <button class="close-btn" onclick="window.closeHelpModal()" aria-label="Close help dialog">✕</button>
            <h2 id="help-title" data-i18n="welcomeTitle">Welcome to Space Voyage!</h2>
            <div id="help-content" role="document"></div>
        </div>
    </div>
    <!-- Import Map for Three.js from CDN -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- Main Application Script with cache buster -->
    <script type="module" src="./src/main.js?v=20251010-pwa"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });
                    
                    console.log('Service Worker registered successfully:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('Service Worker update found');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Show update notification
                                showUpdateNotification();
                            }
                        });
                    });
                    
                    // Handle controller change (new service worker activated)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('New Service Worker activated');
                    });
                    
                } catch (error) {
                    console.warn('Service Worker registration failed:', error);
                }
            });
        } else {
            console.warn('Service Workers not supported in this browser');
        }
        
        // Show update notification UI
        function showUpdateNotification() {
            const notification = document.getElementById('update-notification');
            if (!notification) return;
            
            notification.classList.remove('hidden');
            
            // Update button - reload the page
            document.getElementById('update-reload')?.addEventListener('click', () => {
                window.location.reload();
            }, { once: true });
            
            // Dismiss button
            document.getElementById('update-dismiss')?.addEventListener('click', () => {
                notification.classList.add('hidden');
            }, { once: true });
        }
        
        // Offline/Online detection
        function updateOnlineStatus() {
            const offlineIndicator = document.getElementById('offline-indicator');
            if (!offlineIndicator) return;
            
            if (!navigator.onLine) {
                offlineIndicator.classList.remove('hidden');
            } else {
                offlineIndicator.classList.add('hidden');
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        window.addEventListener('load', updateOnlineStatus);
        
        // PWA Install prompt handling
        let deferredPrompt;
        let installPromptShown = false;
        
        // Check if running as installed PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA install prompt ready');
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Don't show install prompt if already running as installed app
            if (isPWA()) {
                console.log('Already running as installed PWA - hiding install prompt');
                return;
            }
            
            // Show install prompt after 30 seconds if not dismissed
            if (!installPromptShown && !localStorage.getItem('installPromptDismissed')) {
                setTimeout(() => {
                    showInstallPrompt();
                }, 30000);
            }
        });
        
        // Show install prompt UI
        function showInstallPrompt() {
            // Don't show if already installed or no prompt available
            if (!deferredPrompt || installPromptShown || isPWA()) return;
            
            installPromptShown = true;
            const promptElement = document.getElementById('install-prompt');
            if (!promptElement) return;
            
            promptElement.classList.remove('hidden');
            
            // Accept button
            document.getElementById('install-accept')?.addEventListener('click', async () => {
                promptElement.classList.add('hidden');
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                
                deferredPrompt = null;
            }, { once: true });
            
            // Dismiss button
            document.getElementById('install-dismiss')?.addEventListener('click', () => {
                promptElement.classList.add('hidden');
                localStorage.setItem('installPromptDismissed', 'true');
                installPromptShown = false;
            }, { once: true });
        }
        
        // Public function to manually trigger install prompt
        window.showInstallPromotion = showInstallPrompt;
        
        // Track when PWA is installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed successfully');
            const promptElement = document.getElementById('install-prompt');
            if (promptElement) {
                promptElement.classList.add('hidden');
            }
            deferredPrompt = null;
            
            // Track installation (you can send to analytics)
            if (window.gtag) {
                gtag('event', 'pwa_installed', {
                    event_category: 'engagement',
                    event_label: 'PWA Installation'
                });
            }
        });
        
        // Handle URL parameters (for shortcuts)
        const shortcutParams = new URLSearchParams(window.location.search);
        if (shortcutParams.has('planet')) {
            const planet = shortcutParams.get('planet');
            console.log(`Shortcut: Navigating to ${planet}`);
            // Will be handled by main app after load
            window.startupPlanet = planet;
        }
        if (shortcutParams.has('vr') && shortcutParams.get('vr') === 'true') {
            console.log('Shortcut: VR mode requested');
            window.startupVR = true;
        }
        
        // Check and handle installed PWA mode
        if (isPWA()) {
            console.log('Running as installed PWA');
            document.body.classList.add('pwa-mode');
            
            // Hide install prompt if somehow visible
            const installPrompt = document.getElementById('install-prompt');
            if (installPrompt) {
                installPrompt.classList.add('hidden');
            }
            
            // Track PWA usage
            if (window.gtag) {
                gtag('event', 'pwa_used', {
                    event_category: 'engagement',
                    event_label: 'PWA Active Session'
                });
            }
        }
    </script>
</body>
</html>